<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AppBuilder v12.0 Mobile</title>
    <style>
        :root {
            --primary: #2563eb; --primary-dark: #1d4ed8;
            --bg: #f8fafc; --surface: #ffffff;
            --text-main: #0f172a; --text-sub: #64748b;
            --border: #e2e8f0; --success: #10b981; --danger: #ef4444;
            --nav-height: 60px;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg); color: var(--text-main); font-size: 14px; height: 100vh; display: flex; overflow: hidden; }

        /* --- DESKTOP LAYOUT (Default) --- */
        .sidebar { width: 260px; background: #1e293b; color: #94a3b8; display: flex; flex-direction: column; border-right: 1px solid #0f172a; flex-shrink: 0; }
        .logo { padding: 20px; font-size: 1.2rem; font-weight: 700; color: white; border-bottom: 1px solid #334155; }
        .nav-item { padding: 12px 20px; cursor: pointer; display: flex; align-items: center; gap: 12px; transition: 0.2s; border-left: 3px solid transparent; font-weight: 500; }
        .nav-item:hover { background: #334155; color: white; }
        .nav-item.active { background: #0f172a; color: white; border-left-color: var(--primary); }
        
        .main { flex: 1; display: flex; flex-direction: column; height: 100%; position: relative; }
        .header { background: var(--surface); height: 60px; padding: 0 20px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; flex-shrink: 0; }
        .content { flex: 1; overflow-y: auto; padding: 20px; position: relative; }

        /* DESKTOP TABLE */
        .desktop-table-wrap { background: white; border: 1px solid var(--border); border-radius: 8px; overflow: auto; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th { position: sticky; top: 0; background: #f1f5f9; text-align: left; padding: 12px; border-bottom: 1px solid var(--border); font-size: 0.75rem; color: var(--text-sub); text-transform: uppercase; z-index: 5; font-weight: 700; }
        td { padding: 10px 12px; border-bottom: 1px solid var(--border); vertical-align: middle; }
        tr:hover td { background: #f8fafc; }
        
        /* --- MOBILE LAYOUT (Responsive) --- */
        .bottom-nav { display: none; } /* Hidden on Desktop */
        .mobile-card { display: none; }
        .fab { display: none; }

        @media (max-width: 768px) {
            /* Hide Desktop Elements */
            .sidebar { display: none; }
            .desktop-table-wrap { display: none; }
            #header-actions { display: none; } /* Use FAB instead */
            
            /* Adjust Main Layout */
            .main { padding-bottom: calc(var(--nav-height) + 10px); } /* Space for bottom nav */
            .content { padding: 10px; background: #f1f5f9; }
            .header { padding: 0 15px; height: 50px; }
            .header h2 { font-size: 1.1rem; }

            /* Mobile Card View */
            .mobile-list { display: flex; flex-direction: column; gap: 10px; padding-bottom: 80px; }
            .mobile-card { display: flex; flex-direction: column; background: white; border-radius: 12px; padding: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); border: 1px solid var(--border); position: relative; }
            .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
            .card-title { font-weight: 700; font-size: 1rem; color: var(--text-main); }
            .card-id { font-size: 0.7rem; color: #94a3b8; background: #f1f5f9; padding: 2px 6px; border-radius: 4px; }
            .card-row { display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 0.9rem; }
            .card-label { color: var(--text-sub); font-size: 0.8rem; }
            .card-val { font-weight: 500; text-align: right; max-width: 60%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
            .card-actions { margin-top: 10px; padding-top: 10px; border-top: 1px dashed var(--border); display: flex; justify-content: flex-end; gap: 15px; }
            .card-action-btn { color: var(--primary); font-weight: 600; font-size: 0.9rem; background: none; border: none; padding: 5px; }
            .card-action-btn.danger { color: var(--danger); }

            /* Bottom Navigation */
            .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; height: var(--nav-height); background: white; border-top: 1px solid var(--border); display: flex; justify-content: space-around; align-items: center; z-index: 100; box-shadow: 0 -2px 10px rgba(0,0,0,0.03); }
            .nav-btn { display: flex; flex-direction: column; align-items: center; gap: 4px; color: #94a3b8; background: none; border: none; font-size: 0.7rem; font-weight: 600; width: 100%; padding: 8px 0; }
            .nav-btn.active { color: var(--primary); }
            .nav-icon { font-size: 1.4rem; line-height: 1; }

            /* Floating Action Button (FAB) */
            .fab { display: flex; position: fixed; bottom: 80px; right: 20px; width: 56px; height: 56px; background: var(--primary); color: white; border-radius: 50%; align-items: center; justify-content: center; font-size: 2rem; box-shadow: 0 4px 12px rgba(37,99,235,0.4); z-index: 90; cursor: pointer; transition: transform 0.2s; }
            .fab:active { transform: scale(0.95); }
        }

        /* COMMON UI */
        .btn { padding: 8px 16px; border-radius: 6px; border: 1px solid var(--border); background: white; cursor: pointer; font-weight: 600; font-size: 0.9rem; display: inline-flex; align-items: center; gap: 6px; }
        .btn-primary { background: var(--primary); color: white; border-color: var(--primary); }
        .tag { padding: 2px 6px; border-radius: 4px; font-size: 11px; font-weight: 600; }
        .tag-blue { background: #dbeafe; color: #1e40af; }
        
        /* INPUTS (Desktop Inline) */
        .inline-inp { width: 100%; padding: 6px; border: 1px solid var(--primary); border-radius: 4px; box-sizing: border-box; background: #eff6ff; }
        
        /* MODAL (For Mobile & Meta) */
        .modal-wrap { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 200; backdrop-filter: blur(2px); }
        .modal-wrap.open { display: flex; }
        .modal-box { background: white; padding: 25px; border-radius: 12px; width: 90%; max-width: 500px; max-height: 90vh; display: flex; flex-direction: column; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .modal-body { overflow-y: auto; margin: 15px 0; }
        .form-group { margin-bottom: 15px; }
        .form-label { display: block; font-weight: 600; font-size: 0.85rem; margin-bottom: 5px; color: var(--text-sub); }
        .form-control { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; font-size: 1rem; box-sizing: border-box; }
        .form-control:focus { border-color: var(--primary); outline: none; }

        .loader { position: fixed; top:0; left:0; width:100%; height:3px; background: transparent; z-index: 999; }
        .loader.active { background: linear-gradient(90deg, var(--primary), var(--success)); animation: load 1s infinite; }
        @keyframes load { 0% {width:0} 100% {width:100%} }
        
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="logo">AppBuilder v12</div>
    <div id="nav-tables" style="flex:1; overflow-y:auto; padding-top:10px;"></div>
    <div style="border-top:1px solid #334155">
        <div class="nav-item" onclick="App.route('settings')">‚öôÔ∏è <span class="lbl-set">Settings</span></div>
        <div class="nav-item" onclick="App.route('metadata')">üîß <span class="lbl-str">Structure</span></div>
    </div>
</div>

<div class="main">
    <div class="loader" id="loader"></div>
    
    <div class="header">
        <h2 id="page-title">App</h2>
        <div id="header-actions">
            </div>
    </div>

    <div class="content" id="app-content"></div>

    <div class="fab" id="fab-add" onclick="Views.table.startAddMobile()">+</div>
</div>

<div class="bottom-nav">
    <button class="nav-btn active" onclick="App.route('home')">
        <span class="nav-icon">üè†</span>
        <span class="lbl-home">Home</span>
    </button>
    <button class="nav-btn" onclick="App.route('metadata')">
        <span class="nav-icon">üîß</span>
        <span class="lbl-str">Struct</span>
    </button>
    <button class="nav-btn" onclick="App.route('settings')">
        <span class="nav-icon">‚öôÔ∏è</span>
        <span class="lbl-set">Set</span>
    </button>
</div>

<div class="modal-wrap" id="modal">
    <div class="modal-box">
        <h3 id="modal-title" style="margin:0; font-size:1.2rem">Title</h3>
        <div id="modal-body" class="modal-body"></div>
        <div style="display:flex; justify-content:flex-end; gap:10px">
            <button class="btn" onclick="UI.Modal.close()">Cancel</button>
            <button class="btn btn-primary" id="modal-save">Save</button>
        </div>
    </div>
</div>

<script>
/* --- CONFIG & LOCALIZATION --- */
const Lang = {
    ru: { 
        NEW: '–î–æ–±–∞–≤–∏—Ç—å', SAVE: '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å', SETTINGS: '–ù–∞—Å—Ç—Ä–æ–π–∫–∏', STRUCTURE: '–°—Ç—Ä—É–∫—Ç—É—Ä–∞', 
        TABLES: '–¢–∞–±–ª–∏—Ü—ã', HOME: '–ì–ª–∞–≤–Ω–∞—è', EDIT: '–ò–∑–º–µ–Ω–∏—Ç—å', DELETE: '–£–¥–∞–ª–∏—Ç—å', 
        CONFIRM: '–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å?', NO_DATA: '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'
    },
    en: { 
        NEW: 'Add New', SAVE: 'Save', SETTINGS: 'Settings', STRUCTURE: 'Structure', 
        TABLES: 'Tables', HOME: 'Home', EDIT: 'Edit', DELETE: 'Delete', 
        CONFIRM: 'Delete row?', NO_DATA: 'No Data'
    }
};

const API_URL = localStorage.getItem('cfs_url');
const CURRENT_LANG = localStorage.getItem('cfs_lang') || 'ru';
const T = (k) => Lang[CURRENT_LANG][k] || k;
const IS_MOBILE = window.innerWidth <= 768;

/* --- STATE --- */
const State = {
    db: { _Metadata: { data: [] } },
    activeTable: null,
    editingId: null,
    
    async refresh() {
        UI.Loader(true);
        if(!API_URL) return UI.Loader(false);
        try {
            const res = await fetch(`${API_URL}?action=get_all`);
            const json = await res.json();
            if(json.status === 'success') {
                this.db = json.db;
                if(!this.db._Metadata) this.db._Metadata = { data: [] };
                UI.renderNav();
            }
        } catch(e) { console.error(e); }
        UI.Loader(false);
    }
};

/* --- UI --- */
const UI = {
    Loader(show) { document.getElementById('loader').className = show ? 'loader active' : 'loader'; },
    
    translate() {
        document.querySelectorAll('.lbl-set').forEach(el=>el.innerText=T('SETTINGS'));
        document.querySelectorAll('.lbl-str').forEach(el=>el.innerText=T('STRUCTURE'));
        document.querySelectorAll('.lbl-home').forEach(el=>el.innerText=T('HOME'));
    },

    renderNav() {
        // Desktop Sidebar
        const c = document.getElementById('nav-tables');
        c.innerHTML = `<div style="padding:0 20px;font-size:0.7rem;color:#64748b;font-weight:bold;margin-bottom:5px;text-transform:uppercase">${T('TABLES')}</div>`;
        const tables = Object.keys(State.db).filter(t => !t.startsWith('_'));
        
        tables.forEach(t => {
            const d = document.createElement('div');
            d.className = 'nav-item';
            d.innerHTML = `üìÑ ${t}`;
            d.onclick = () => App.route('table', t);
            c.appendChild(d);
        });

        // Mobile Home Screen (Table List)
        if(IS_MOBILE && State.activeTable === null) {
            const content = document.getElementById('app-content');
            let html = `<div class="mobile-list">`;
            tables.forEach(t => {
                html += `
                <div class="mobile-card" onclick="App.route('table', '${t}')" style="flex-direction:row; align-items:center; justify-content:space-between">
                    <span class="card-title">üìÑ ${t}</span>
                    <span style="color:#cbd5e1">‚û§</span>
                </div>`;
            });
            html += `</div>`;
            content.innerHTML = html;
            document.getElementById('page-title').innerText = T('HOME');
            document.getElementById('fab-add').style.display = 'none';
        }
    },

    Modal: {
        open(title, renderFn, onSave) {
            document.getElementById('modal-title').innerText = title;
            const body = document.getElementById('modal-body');
            body.innerHTML = '';
            renderFn(body);
            document.getElementById('modal-save').onclick = async () => { await onSave(); UI.Modal.close(); };
            document.getElementById('modal').classList.add('open');
        },
        close() { document.getElementById('modal').classList.remove('open'); }
    },

    // Universal Form Renderer
    Form: {
        render(cont, table, row={}) {
            if(row.id) cont.innerHTML += `<input type="hidden" id="f_id" value="${row.id}">`;
            
            let meta = State.db._Metadata.data.filter(m => m.table_name === table);
            if(!meta.length && State.db[table]) {
                State.db[table].headers.forEach(h => meta.push({field_name: h, data_type: h==='id'?'PK':'TEXT', is_shown: true}));
            }

            meta.forEach(m => {
                if(m.is_shown === false || (m.data_type === 'PK' && !row.id)) return;

                const grp = document.createElement('div');
                grp.className = 'form-group';
                grp.innerHTML = `<label class="form-label">${m.field_name}</label>`;
                
                let input;
                const val = row[m.field_name] || '';

                if(m.data_type === 'FK') {
                    input = document.createElement('select');
                    input.className = 'form-control';
                    input.id = `inp_${m.field_name}`;
                    input.innerHTML = '<option value="">-</option>';
                    if(m.ref_table && State.db[m.ref_table]) {
                        State.db[m.ref_table].data.forEach(r => {
                            const tm = State.db._Metadata.data.filter(x=>x.table_name===m.ref_table);
                            const lbl = r[tm.find(x=>x.is_label)?.field_name||'name'] || r.id;
                            const sel = String(r.id)===String(val)?'selected':'';
                            input.innerHTML += `<option value="${r.id}" ${sel}>${lbl}</option>`;
                        });
                    }
                } else if (m.data_type === 'DATE') {
                    input = document.createElement('input'); input.type='date'; input.className='form-control';
                    input.id = `inp_${m.field_name}`;
                    if(val) input.value = new Date(val).toISOString().split('T')[0];
                } else {
                    input = document.createElement('input'); input.className='form-control';
                    input.id = `inp_${m.field_name}`;
                    input.value = val;
                    if(m.data_type === 'PK') input.disabled = true;
                }
                grp.appendChild(input);
                cont.appendChild(grp);
            });
        },
        collect(table) {
            const d = {};
            if(document.getElementById('f_id')) { d.id = document.getElementById('f_id').value; d.is_edit=true; }
            const meta = State.db._Metadata.data.filter(m => m.table_name === table);
            // Fallback headers if meta missing
            const headers = State.db[table]?.headers || [];
            
            const fieldsToCheck = meta.length ? meta.map(m=>m.field_name) : headers;

            fieldsToCheck.forEach(f => {
                const el = document.getElementById('inp_'+f);
                if(el) d[f] = el.value;
            });
            return d;
        }
    }
};

/* --- VIEWS --- */
const Views = {
    table: {
        render(name) {
            State.activeTable = name;
            document.getElementById('page-title').innerText = name;
            
            const cont = document.getElementById('app-content');
            const data = State.db[name].data || [];
            
            // Get Meta
            let meta = State.db._Metadata.data.filter(m => m.table_name === name);
            if(!meta.length && State.db[name]) {
                State.db[name].headers.forEach(h => meta.push({field_name: h, data_type: h==='id'?'PK':'TEXT', is_shown: true}));
            }
            const visibleCols = meta.filter(m => m.is_shown !== false);

            // --- MOBILE VIEW (CARDS) ---
            if(IS_MOBILE) {
                document.getElementById('fab-add').style.display = 'flex';
                let html = `<div class="mobile-list">`;
                
                if(!data.length) html += `<div style="text-align:center; padding:40px; color:#94a3b8">${T('NO_DATA')}</div>`;
                
                data.forEach(row => {
                    // Identify Title Field (Label or 2nd column)
                    const titleField = meta.find(m => m.is_label)?.field_name || visibleCols[1]?.field_name || 'id';
                    const titleVal = row[titleField] || 'Item';
                    
                    html += `<div class="mobile-card">
                        <div class="card-header">
                            <span class="card-title">${titleVal}</span>
                            <span class="card-id">#${row.id}</span>
                        </div>`;
                    
                    // Render first 4 fields
                    visibleCols.slice(0, 5).forEach(m => {
                        if(m.field_name === titleField || m.field_name === 'id') return;
                        let val = row[m.field_name];
                        if(m.data_type === 'FK' && m.ref_table) {
                            const tr = State.db[m.ref_table]?.data.find(r=>String(r.id)===String(val));
                            if(tr) {
                                const tm = State.db._Metadata.data.filter(x=>x.table_name===m.ref_table);
                                val = tr[tm.find(x=>x.is_label)?.field_name||'name'] || val;
                            }
                        }
                        html += `<div class="card-row"><span class="card-label">${m.field_name}</span><span class="card-val">${val||'-'}</span></div>`;
                    });

                    html += `
                        <div class="card-actions">
                            <button class="card-action-btn" onclick='Views.table.editModal("${name}", ${JSON.stringify(row)})'>${T('EDIT')}</button>
                            <button class="card-action-btn danger" onclick='Views.table.del("${name}", "${row.id}")'>${T('DELETE')}</button>
                        </div>
                    </div>`;
                });
                html += `</div>`;
                cont.innerHTML = html;
            
            // --- DESKTOP VIEW (GRID) ---
            } else {
                document.getElementById('header-actions').innerHTML = `<button class="btn btn-primary" onclick="Views.table.startAddDesktop()">‚ûï ${T('NEW')}</button>`;
                document.getElementById('fab-add').style.display = 'none';
                
                let html = `<div class="desktop-table-wrap"><table><thead><tr>`;
                visibleCols.forEach(m => html += `<th>${m.field_name}</th>`);
                html += `<th style="width:100px"></th></tr></thead><tbody>`;

                // Add Row (Desktop Inline)
                if(State.isAdding) html += Views.table.renderRowInput(visibleCols, {}, 'new');

                data.forEach(row => {
                    if(State.editingId === row.id) html += Views.table.renderRowInput(visibleCols, row, row.id);
                    else html += Views.table.renderRowDisplay(visibleCols, row, name);
                });
                html += `</tbody></table></div>`;
                cont.innerHTML = html;
            }
        },

        // --- DESKTOP RENDERERS ---
        renderRowDisplay(cols, row, tableName) {
            let html = `<tr>`;
            cols.forEach(m => {
                let val = row[m.field_name];
                if(m.data_type === 'FK' && m.ref_table) {
                    const tr = State.db[m.ref_table]?.data.find(r=>String(r.id)===String(val));
                    if(tr) {
                        const tm = State.db._Metadata.data.filter(x=>x.table_name===m.ref_table);
                        val = `<span class="tag tag-blue">${tr[tm.find(x=>x.is_label)?.field_name||'name'] || val}</span>`;
                    }
                }
                html += `<td>${val === undefined ? '' : val}</td>`;
            });
            html += `<td style="text-align:right">
                <button class="btn" style="padding:2px 6px" onclick="Views.table.startEditDesktop('${row.id}')">‚úèÔ∏è</button>
                <button class="btn" style="padding:2px 6px;color:red" onclick="Views.table.del('${tableName}', '${row.id}')">üóëÔ∏è</button>
            </td></tr>`;
            return html;
        },
        renderRowInput(cols, rowData, rowId) {
            let html = `<tr style="background:#f8fafc; border-left:3px solid var(--primary)">`;
            cols.forEach(m => {
                let val = rowData[m.field_name] || '';
                let input = '';
                if(m.data_type === 'PK') input = `<input class="inline-inp" value="${val}" disabled style="background:#e2e8f0;">`;
                else if(m.data_type === 'FK') {
                    let opts = `<option value="">-</option>`;
                    if(m.ref_table && State.db[m.ref_table]) {
                        State.db[m.ref_table].data.forEach(r => {
                            const tm = State.db._Metadata.data.filter(x=>x.table_name===m.ref_table);
                            const lbl = r[tm.find(x=>x.is_label)?.field_name||'name'] || r.id;
                            opts += `<option value="${r.id}" ${String(r.id)===String(val)?'selected':''}>${lbl}</option>`;
                        });
                    }
                    input = `<select id="inp_${m.field_name}" class="inline-inp">${opts}</select>`;
                } else if (m.data_type === 'DATE') {
                    input = `<input type="date" id="inp_${m.field_name}" class="inline-inp" value="${val ? new Date(val).toISOString().split('T')[0] : ''}">`;
                } else input = `<input id="inp_${m.field_name}" class="inline-inp" value="${val}">`;
                html += `<td>${input}</td>`;
            });
            html += `<td style="text-align:right"><button class="btn btn-primary" style="padding:4px" onclick="Views.table.save('${rowId}')">OK</button> <button class="btn" style="padding:4px" onclick="Views.table.cancel()">X</button></td></tr>`;
            return html;
        },

        // --- ACTIONS ---
        startAddDesktop() { State.isAdding = true; State.editingId = null; Views.table.render(State.activeTable); },
        startEditDesktop(id) { State.editingId = id; State.isAdding = false; Views.table.render(State.activeTable); },
        cancel() { State.isAdding = false; State.editingId = null; Views.table.render(State.activeTable); },
        
        // Mobile Actions (Modal based)
        startAddMobile() {
            UI.Modal.open(T('NEW'), box => UI.Form.render(box, State.activeTable), () => Views.table.save('new'));
        },
        editModal(table, row) {
            UI.Modal.open(T('EDIT'), box => UI.Form.render(box, table, row), () => Views.table.save(row.id));
        },

        async save(rowId) {
            const table = State.activeTable;
            const data = UI.Form.collect(table); // Universal collector works for both inline and modal if IDs match
            if(rowId !== 'new') { data.id = rowId; data.is_edit = true; }
            
            UI.Loader(true);
            await fetch(`${API_URL}?action=save_row`, {method:'POST', body:JSON.stringify({table, data})});
            await State.refresh();
            State.isAdding = false; State.editingId = null;
            Views.table.render(table);
            UI.Loader(false);
        },
        async del(n, id) {
            if(!confirm(T('CONFIRM'))) return;
            UI.Loader(true);
            await fetch(`${API_URL}?action=delete&table=${n}&id=${id}`);
            await State.refresh();
            Views.table.render(n);
            UI.Loader(false);
        }
    },

    metadata: {
        render() {
            document.getElementById('page-title').innerText = T('STRUCTURE');
            document.getElementById('header-actions').innerHTML = '';
            document.getElementById('fab-add').style.display = 'none';
            document.getElementById('app-content').innerHTML = `
                <div style="padding:10px; text-align:center">Metadata Editor is Desktop Optimized.<br>Please use a larger screen to edit structure.</div>
            `;
            if(!IS_MOBILE) {
                // Desktop Metadata Editor (Simplified for brevity, full logic in prev versions)
                document.getElementById('app-content').innerHTML = `<div style="padding:20px">Use "Sync" to auto-detect fields.<br><button class="btn" onclick="fetch('${API_URL}?action=sync_meta').then(()=>location.reload())">üîÑ Sync Structure</button></div>`;
            }
        }
    },

    settings: {
        render() {
            document.getElementById('page-title').innerText = T('SETTINGS');
            document.getElementById('header-actions').innerHTML = '';
            document.getElementById('fab-add').style.display = 'none';
            document.getElementById('app-content').innerHTML = `
                <div style="padding:20px; max-width:500px; background:white; border-radius:8px">
                     <label style="font-weight:600;display:block;margin-bottom:5px">${T('LBL_URL')}</label>
                     <input id="url" value="${API_URL||''}" style="width:100%;padding:10px;margin-bottom:15px;border:1px solid #ddd;border-radius:6px">
                     <label style="font-weight:600;display:block;margin-bottom:5px">${T('LBL_LANG')}</label>
                     <select id="lang" style="width:100%;padding:10px;margin-bottom:15px;border:1px solid #ddd;border-radius:6px">
                        <option value="ru" ${CURRENT_LANG==='ru'?'selected':''}>–†—É—Å—Å–∫–∏–π</option>
                        <option value="en" ${CURRENT_LANG==='en'?'selected':''}>English</option>
                     </select>
                     <button class="btn btn-primary" onclick="localStorage.setItem('cfs_url', document.getElementById('url').value);localStorage.setItem('cfs_lang', document.getElementById('lang').value);location.reload()">${T('SAVE')}</button>
                </div>`;
        }
    }
};

const App = { 
    init() { 
        UI.translate(); 
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        
        if(API_URL) State.refresh().then(() => {
            if(IS_MOBILE) App.route('home'); // Mobile Home
            else { 
                const keys = Object.keys(State.db).filter(k=>!k.startsWith('_'));
                if(keys.length) App.route('table', keys[0]); else App.route('settings');
            }
        }); 
        else App.route('settings'); 
    }, 
    route(v,p) { 
        State.isAdding=false; State.editingId=null;
        
        // Desktop Nav Update
        document.querySelectorAll('.sidebar .nav-item').forEach(e=>e.classList.remove('active'));
        
        // Mobile Nav Update
        document.querySelectorAll('.bottom-nav .nav-btn').forEach(e=>e.classList.remove('active'));

        if(v==='table') { 
            Views.table.render(p); 
            // Highlight table in sidebar
        } else if(v==='home') {
             UI.renderNav(); // Renders list
             document.querySelector('.bottom-nav .nav-btn:nth-child(1)').classList.add('active');
        } else if(v==='metadata') { 
            Views.metadata.render(); 
            document.querySelector('[onclick*="metadata"]').classList.add('active'); // Sidebar
            if(IS_MOBILE) document.querySelector('.bottom-nav .nav-btn:nth-child(2)').classList.add('active');
        } else { 
            Views.settings.render(); 
            document.querySelector('[onclick*="settings"]').classList.add('active'); // Sidebar
            if(IS_MOBILE) document.querySelector('.bottom-nav .nav-btn:nth-child(3)').classList.add('active');
        }
    } 
};
window.onload = App.init;
</script>
</body>
</html>